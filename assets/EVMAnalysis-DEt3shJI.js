import{d as v,r as k,j as e,C as E,b as V,z as A,F as M,T as $}from"./index-dIhSveSg.js";import{A as y}from"./activity-BrpyVOoW.js";import{C as F}from"./calendar-DMjAWnfr.js";import{T}from"./target-CnQovXZ5.js";import{D as z}from"./dollar-sign-DDFoO7hq.js";import{R as L,C as O,X as H,Y as R,T as B,L as U,v as W}from"./generateCategoricalChart-PO57mRpp.js";import{L as K}from"./LineChart-DpW29X3X.js";import{L as N}from"./Line-Cd1XaBT5.js";import{m as Y}from"./proxy-Dsy0yqdO.js";import{D as _}from"./download-C5Wk7BG9.js";function w(s){const t=new Date,a=new Date(s.startDate),l=new Date(s.endDate),r=v(l,a),n=v(t,a),o=Math.min(Math.max(n/r,0),1),d=s.budget||s.totalBudget||0,h=s.actualCost||s.budgetUsed||0,i=d*o,x=(s.progress||0)/100,c=d*x,g=h,u=i>0?c/i:1,b=g>0?c/g:1,C=c-i,p=c-g,f=b>0?d/b:d,j=f-g,I=d-f,D=d-c,P=d-g,S=P>0?D/P:1;return{projectId:s.id,asOfDate:t.toISOString(),plannedValue:i,earnedValue:c,actualCost:g,schedulePerformanceIndex:u,costPerformanceIndex:b,scheduleVariance:C,costVariance:p,estimateAtCompletion:f,estimateToComplete:j,varianceAtCompletion:I,toCompletePerformanceIndex:S}}function G(s,t=10){const a=new Date(s.startDate),l=new Date(s.endDate),r=new Date,n=v(l,a),o=s.budget||s.totalBudget||0,d=(s.progress||0)/100,h=s.actualCost||s.budgetUsed||0,i=[];for(let x=0;x<=t;x++){const c=x/t,g=Math.floor(n*c),u=new Date(a);u.setDate(u.getDate()+g);const b=u<=r,C=o*c;let p=0;if(b){const j=Math.min(c/(v(r,a)/n)*d,d);p=o*j}let f=0;if(b){const j=p/(o*d||1);f=h*j}i.push({date:u.toISOString().split("T")[0],pv:Math.round(C),ev:Math.round(p),ac:Math.round(f)})}return i}function X(s){let t;s.schedulePerformanceIndex>=1.05?t="ahead":s.schedulePerformanceIndex>=.95?t="on-track":t="behind";let a;s.costPerformanceIndex>=1.05?a="under-budget":s.costPerformanceIndex>=.95?a="on-budget":a="over-budget";let l;return s.schedulePerformanceIndex>=.95&&s.costPerformanceIndex>=.95?l="good":s.schedulePerformanceIndex>=.85&&s.costPerformanceIndex>=.85?l="warning":l="critical",{scheduleStatus:t,costStatus:a,overallHealth:l}}function m(s){return s>=1e4?`¥${(s/1e4).toFixed(1)}万`:`¥${s.toLocaleString()}`}function q(s){return s.toFixed(2)}function J(s){return s>=1.05?"text-green-600 dark:text-green-400":s>=.95?"text-blue-600 dark:text-blue-400":s>=.85?"text-orange-600 dark:text-orange-400":"text-red-600 dark:text-red-400"}const Q=({project:s})=>{const t=k.useMemo(()=>w(s),[s]),a=k.useMemo(()=>G(s,12),[s]),l=k.useMemo(()=>X(t),[t]),r=({icon:o,label:d,value:h,subtitle:i,status:x})=>{const c={good:"border-green-500 bg-green-50 dark:bg-green-900/20",warning:"border-orange-500 bg-orange-50 dark:bg-orange-900/20",critical:"border-red-500 bg-red-50 dark:bg-red-900/20"};return e.jsxs("div",{className:`p-4 rounded-lg border-2 ${x?c[x]:"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"text-slate-600 dark:text-slate-400",children:o}),e.jsx("span",{className:"text-xs font-medium text-slate-600 dark:text-slate-400 uppercase",children:d})]}),e.jsx("div",{className:"text-2xl font-bold text-slate-900 dark:text-slate-100",children:h}),i&&e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 mt-1",children:i})]})},n=({label:o,value:d,threshold:h})=>{const i=Math.min(d/h*100,150),x=J(d);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:o}),e.jsx("span",{className:`text-lg font-bold ${x}`,children:q(d)})]}),e.jsxs("div",{className:"relative h-3 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden",children:[e.jsx(Y.div,{initial:{width:0},animate:{width:`${i}%`},transition:{duration:1,ease:"easeOut"},className:`absolute top-0 left-0 h-full rounded-full ${d>=1.05?"bg-green-500":d>=.95?"bg-blue-500":d>=.85?"bg-orange-500":"bg-red-500"}`}),e.jsx("div",{className:"absolute top-0 h-full w-0.5 bg-slate-900 dark:bg-slate-100",style:{left:`${h/1.5*100}%`}})]}),e.jsxs("div",{className:"flex justify-between text-xs text-slate-500 dark:text-slate-400",children:[e.jsx("span",{children:"0.0"}),e.jsx("span",{children:"1.0 (目标)"}),e.jsx("span",{children:"1.5"})]})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2",children:[e.jsx(y,{className:"text-blue-600 dark:text-blue-400",size:28}),"挣值管理 (EVM)"]}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mt-1",children:"Earned Value Management - 财务绩效分析"})]}),e.jsx("div",{className:`px-4 py-2 rounded-lg ${l.overallHealth==="good"?"bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400":l.overallHealth==="warning"?"bg-orange-100 dark:bg-orange-900/20 text-orange-700 dark:text-orange-400":"bg-red-100 dark:bg-red-900/20 text-red-700 dark:text-red-400"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[l.overallHealth==="good"?e.jsx(E,{size:20}):l.overallHealth==="warning"?e.jsx(V,{size:20}):e.jsx(V,{size:20}),e.jsx("span",{className:"font-bold",children:l.overallHealth==="good"?"健康":l.overallHealth==="warning"?"警告":"风险"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(r,{icon:e.jsx(F,{size:20}),label:"计划价值 (PV)",value:m(t.plannedValue),subtitle:"应该完成的工作价值"}),e.jsx(r,{icon:e.jsx(T,{size:20}),label:"挣值 (EV)",value:m(t.earnedValue),subtitle:"实际完成的工作价值",status:t.earnedValue>=t.plannedValue?"good":t.earnedValue>=t.plannedValue*.9?"warning":"critical"}),e.jsx(r,{icon:e.jsx(z,{size:20}),label:"实际成本 (AC)",value:m(t.actualCost),subtitle:"实际花费的成本",status:t.actualCost<=t.earnedValue?"good":t.actualCost<=t.earnedValue*1.1?"warning":"critical"})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-slate-100 mb-4",children:"S 曲线分析"}),e.jsx(L,{width:"100%",height:350,children:e.jsxs(K,{data:a,children:[e.jsx(O,{strokeDasharray:"3 3",stroke:"#e2e8f0"}),e.jsx(H,{dataKey:"date",tick:{fontSize:12},tickFormatter:o=>new Date(o).toLocaleDateString("zh-CN",{month:"short",day:"numeric"})}),e.jsx(R,{tick:{fontSize:12},tickFormatter:o=>`¥${(o/1e4).toFixed(0)}万`}),e.jsx(B,{formatter:o=>m(o),labelFormatter:o=>new Date(o).toLocaleDateString("zh-CN")}),e.jsx(U,{}),e.jsx(W,{y:s.budget||0,stroke:"#94a3b8",strokeDasharray:"3 3",label:"预算"}),e.jsx(N,{type:"monotone",dataKey:"pv",stroke:"#3b82f6",strokeWidth:2,name:"计划价值 (PV)",dot:!1}),e.jsx(N,{type:"monotone",dataKey:"ev",stroke:"#10b981",strokeWidth:2,name:"挣值 (EV)",dot:!1}),e.jsx(N,{type:"monotone",dataKey:"ac",stroke:"#ef4444",strokeWidth:2,name:"实际成本 (AC)",dot:!1})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 space-y-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-slate-100",children:"绩效指数"}),e.jsx(n,{label:"进度绩效指数 (SPI)",value:t.schedulePerformanceIndex,threshold:1}),e.jsx(n,{label:"成本绩效指数 (CPI)",value:t.costPerformanceIndex,threshold:1}),e.jsxs("div",{className:"pt-4 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"SPI > 1.0:"})," 进度超前 | ",e.jsx("strong",{children:"SPI < 1.0:"})," 进度落后"]}),e.jsxs("p",{className:"mt-1",children:[e.jsx("strong",{children:"CPI > 1.0:"})," 成本节约 | ",e.jsx("strong",{children:"CPI < 1.0:"})," 成本超支"]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 dark:text-slate-100 mb-4",children:"偏差与预测"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"进度偏差 (SV)"}),e.jsxs("span",{className:`text-lg font-bold ${t.scheduleVariance>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[t.scheduleVariance>=0?"+":"",m(t.scheduleVariance)]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"成本偏差 (CV)"}),e.jsxs("span",{className:`text-lg font-bold ${t.costVariance>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[t.costVariance>=0?"+":"",m(t.costVariance)]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"完工估算 (EAC)"}),e.jsx("span",{className:"text-lg font-bold text-slate-900 dark:text-slate-100",children:m(t.estimateAtCompletion)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"完工尚需估算 (ETC)"}),e.jsx("span",{className:"text-lg font-bold text-slate-900 dark:text-slate-100",children:m(t.estimateToComplete)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900/50 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"完工偏差 (VAC)"}),e.jsxs("span",{className:`text-lg font-bold ${t.varianceAtCompletion>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[t.varianceAtCompletion>=0?"+":"",m(t.varianceAtCompletion)]})]})]})]})]})]})};function Z(s){const t=w(s),a=["项目名称","截止日期","计划价值(PV)","挣值(EV)","实际成本(AC)","进度绩效指数(SPI)","成本绩效指数(CPI)","进度偏差(SV)","成本偏差(CV)","完工估算(EAC)","完工尚需估算(ETC)","完工偏差(VAC)","完工尚需绩效指数(TCPI)"],l=[s.name,new Date(t.asOfDate).toLocaleDateString("zh-CN"),t.plannedValue.toFixed(2),t.earnedValue.toFixed(2),t.actualCost.toFixed(2),t.schedulePerformanceIndex.toFixed(3),t.costPerformanceIndex.toFixed(3),t.scheduleVariance.toFixed(2),t.costVariance.toFixed(2),t.estimateAtCompletion.toFixed(2),t.estimateToComplete.toFixed(2),t.varianceAtCompletion.toFixed(2),t.toCompletePerformanceIndex.toFixed(3)],r=[a.join(","),l.join(",")].join(`
`);te(r,`EVM报告_${s.name}_${new Date().toISOString().split("T")[0]}.csv`)}function ee(s){const t=w(s),a=`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EVM 报告 - ${s.name}</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 40px; color: #333; }
        h1 { color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px; }
        h2 { color: #1e40af; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f3f4f6; font-weight: bold; }
        .positive { color: #059669; }
        .negative { color: #dc2626; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #6b7280; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>挣值管理 (EVM) 报告</h1>
    <div style="margin: 20px 0;">
        <p><strong>项目名称：</strong>${s.name}</p>
        <p><strong>项目经理：</strong>${s.manager||"未分配"}</p>
        <p><strong>报告日期：</strong>${new Date(t.asOfDate).toLocaleDateString("zh-CN")}</p>
    </div>
    <h2>核心指标</h2>
    <table>
        <tr><th>指标</th><th>值</th><th>说明</th></tr>
        <tr><td>计划价值 (PV)</td><td>¥${t.plannedValue.toLocaleString()}</td><td>按计划应该完成的工作价值</td></tr>
        <tr><td>挣值 (EV)</td><td>¥${t.earnedValue.toLocaleString()}</td><td>实际完成的工作价值</td></tr>
        <tr><td>实际成本 (AC)</td><td>¥${t.actualCost.toLocaleString()}</td><td>实际花费的成本</td></tr>
    </table>
    <h2>绩效指数</h2>
    <table>
        <tr><th>指标</th><th>值</th><th>状态</th></tr>
        <tr><td>进度绩效指数 (SPI)</td><td>${t.schedulePerformanceIndex.toFixed(3)}</td><td class="${t.schedulePerformanceIndex>=1?"positive":"negative"}">${t.schedulePerformanceIndex>=1?"进度超前":"进度落后"}</td></tr>
        <tr><td>成本绩效指数 (CPI)</td><td>${t.costPerformanceIndex.toFixed(3)}</td><td class="${t.costPerformanceIndex>=1?"positive":"negative"}">${t.costPerformanceIndex>=1?"成本节约":"成本超支"}</td></tr>
    </table>
    <div class="footer">
        <p>此报告由 Visorq PMO 系统自动生成 · 生成时间：${new Date().toLocaleString("zh-CN")}</p>
    </div>
</body>
</html>
    `;se(a,`EVM报告_${s.name}`)}function te(s,t){const a="\uFEFF",l=new Blob([a+s],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),n=URL.createObjectURL(l);r.setAttribute("href",n),r.setAttribute("download",t),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)}function se(s,t){const a=window.open("","_blank");a&&(a.document.write(s),a.document.close(),a.focus(),setTimeout(()=>{a.print()},500))}const he=()=>{const s=A(),t=s.filter(n=>n.status==="active"||n.status==="planning"),[a,l]=k.useState(t.length>0?t[0].id:""),r=s.find(n=>n.id===a);return t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-96 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700",children:[e.jsx(V,{size:64,className:"text-slate-300 dark:text-slate-600 mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-slate-900 dark:text-slate-100 mb-2",children:"暂无活跃项目"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"创建项目后即可查看挣值管理分析"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-3",children:[e.jsx(y,{className:"text-blue-600 dark:text-blue-400",size:32}),"挣值管理分析"]}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 mt-1",children:"Earned Value Management - 项目财务绩效可视化"})]}),r&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>Z(r),className:"flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors",children:[e.jsx(_,{size:16}),"导出 CSV"]}),e.jsxs("button",{onClick:()=>ee(r),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors",children:[e.jsx(M,{size:16}),"导出 PDF"]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"选择项目"}),e.jsx("select",{value:a,onChange:n=>l(n.target.value),className:"w-full md:w-96 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:t.map(n=>e.jsxs("option",{value:n.id,children:[n.name," - ",n.manager||"未分配"]},n.id))})]}),r&&e.jsx(Q,{project:r}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl shadow-sm border border-blue-200 dark:border-blue-800 p-6",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-900 dark:text-slate-100 mb-4 flex items-center gap-2",children:[e.jsx($,{className:"text-blue-600 dark:text-blue-400",size:20}),"EVM 指标说明"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-slate-100 mb-2",children:"核心指标"}),e.jsxs("ul",{className:"space-y-1 text-slate-700 dark:text-slate-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"PV (计划价值):"})," 按计划应该完成的工作价值"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"EV (挣值):"})," 实际完成的工作价值"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"AC (实际成本):"})," 实际花费的成本"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-slate-100 mb-2",children:"绩效指数"}),e.jsxs("ul",{className:"space-y-1 text-slate-700 dark:text-slate-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"SPI (进度绩效指数):"})," EV / PV，衡量进度效率"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"CPI (成本绩效指数):"})," EV / AC，衡量成本效率"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"TCPI (完工尚需绩效指数):"})," 剩余工作需要的效率"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-slate-100 mb-2",children:"偏差指标"}),e.jsxs("ul",{className:"space-y-1 text-slate-700 dark:text-slate-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"SV (进度偏差):"})," EV - PV，正值表示进度超前"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"CV (成本偏差):"})," EV - AC，正值表示成本节约"]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-slate-900 dark:text-slate-100 mb-2",children:"预测指标"}),e.jsxs("ul",{className:"space-y-1 text-slate-700 dark:text-slate-300",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"EAC (完工估算):"})," 预计项目总成本"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"ETC (完工尚需估算):"})," 完成项目还需多少成本"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"VAC (完工偏差):"})," 预算 - EAC，预计的成本偏差"]})]})]})]})]})]})};export{he as default};
