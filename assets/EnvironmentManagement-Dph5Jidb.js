import{e as I,r as h,j as e,X as S,u as B,b as E,C as $}from"./index-C4k-wXvD.js";import{u as M}from"./usePMOStore-BhuSuNUu.js";import{P as A,a as O}from"./PageHeader-BcC-cces.js";import{C as y}from"./Card-yU_DaN3z.js";import{B as g,a as P}from"./Badge-q-IMKz70.js";import{C as N}from"./calendar-DR3tkqjj.js";import{P as D}from"./plus-CbPmTqIt.js";import{C as z}from"./clock-CvHnY7zi.js";/**
 * @license lucide-react v0.428.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=I("Server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]),L=({isOpen:j,onClose:b,onAdd:c})=>{const[r,p]=h.useState({name:"",type:"test",status:"available",description:"",capacity:1,location:"",tags:""}),[l,s]=h.useState({}),k=[{value:"test",label:"测试环境",description:"用于功能测试和QA验证"},{value:"staging",label:"预发布环境",description:"生产前的最终验证环境"},{value:"production",label:"生产环境",description:"正式生产环境"},{value:"integration",label:"集成环境",description:"系统集成测试环境"},{value:"device",label:"设备资源",description:"物理设备或硬件资源"},{value:"license",label:"许可证",description:"软件许可证或授权"}],d=[{value:"available",label:"可用",color:"text-green-600"},{value:"occupied",label:"占用中",color:"text-blue-600"},{value:"maintenance",label:"维护中",color:"text-yellow-600"},{value:"offline",label:"离线",color:"text-red-600"}],x=()=>{const a={};return r.name.trim()||(a.name="请输入环境名称"),r.capacity&&r.capacity<1&&(a.capacity="容量必须大于0"),s(a),Object.keys(a).length===0},f=a=>{if(a.preventDefault(),!x())return;const m=r.tags.split(",").map(t=>t.trim()).filter(t=>t.length>0);c({name:r.name.trim(),type:r.type,status:r.status,description:r.description.trim()||void 0,capacity:r.capacity||void 0,location:r.location.trim()||void 0,tags:m.length>0?m:void 0}),p({name:"",type:"test",status:"available",description:"",capacity:1,location:"",tags:""}),s({}),b()},o=(a,m)=>{p(t=>({...t,[a]:m})),l[a]&&s(t=>{const n={...t};return delete n[a],n})};return j?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-slate-100",children:"添加环境资源"}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:"添加测试环境、设备或许可证等资源"})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors",children:e.jsx(S,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("form",{onSubmit:f,className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["环境名称 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:r.name,onChange:a=>o("name",a.target.value),placeholder:"例如：测试环境-01",className:`w-full px-4 py-2 rounded-lg border ${l.name?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent`}),l.name&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:l.name})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["资源类型 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:k.map(a=>e.jsxs("button",{type:"button",onClick:()=>o("type",a.value),className:`p-3 rounded-lg border-2 text-left transition-all ${r.type===a.value?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600"}`,children:[e.jsx("div",{className:"font-medium text-slate-900 dark:text-slate-100",children:a.label}),e.jsx("div",{className:"text-xs text-slate-500 dark:text-slate-400 mt-1",children:a.description})]},a.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"初始状态"}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:d.map(a=>e.jsx("button",{type:"button",onClick:()=>o("status",a.value),className:`px-4 py-2 rounded-lg border-2 transition-all ${r.status===a.value?"border-blue-500 bg-blue-50 dark:bg-blue-900/20":"border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600"}`,children:e.jsx("span",{className:`font-medium ${a.color}`,children:a.label})},a.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"描述"}),e.jsx("textarea",{value:r.description,onChange:a=>o("description",a.target.value),placeholder:"环境的详细描述、配置信息等...",rows:3,className:"w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"容量"}),e.jsx("input",{type:"number",value:r.capacity,onChange:a=>o("capacity",parseInt(a.target.value)||0),min:"1",placeholder:"1",className:`w-full px-4 py-2 rounded-lg border ${l.capacity?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent`}),l.capacity&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:l.capacity})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"位置"}),e.jsx("input",{type:"text",value:r.location,onChange:a=>o("location",a.target.value),placeholder:"例如：机房A-01",className:"w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"标签"}),e.jsx("input",{type:"text",value:r.tags,onChange:a=>o("tags",a.target.value),placeholder:"用逗号分隔，例如：高性能,Linux,Docker",className:"w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"}),e.jsx("p",{className:"mt-1 text-xs text-slate-500 dark:text-slate-400",children:"使用逗号分隔多个标签"})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50",children:[e.jsx(g,{type:"button",variant:"secondary",onClick:b,children:"取消"}),e.jsx(g,{type:"submit",onClick:f,children:"添加环境资源"})]})]})}):null},T=({isOpen:j,onClose:b,environment:c,onBook:r})=>{const{projects:p,user:l}=B(),[s,k]=h.useState({projectId:"",startDate:"",endDate:"",purpose:""}),[d,x]=h.useState({}),f=()=>{const t={};if(s.projectId||(t.projectId="请选择项目"),s.startDate||(t.startDate="请选择开始日期"),s.endDate||(t.endDate="请选择结束日期"),s.startDate&&s.endDate){const n=new Date(s.startDate);new Date(s.endDate)<=n&&(t.endDate="结束日期必须晚于开始日期")}return s.purpose.trim()||(t.purpose="请输入预约目的"),x(t),Object.keys(t).length===0},o=t=>{if(t.preventDefault(),!f()||!c)return;const n=p.find(w=>w.id===s.projectId);if(!n)return;const u=new Date,v=new Date(s.startDate)<=u?"active":"reserved";r({environmentId:c.id,projectId:s.projectId,projectName:n.name,bookedBy:(l==null?void 0:l.id)||"unknown",bookedByName:(l==null?void 0:l.name)||(l==null?void 0:l.username)||"Unknown User",startDate:s.startDate,endDate:s.endDate,purpose:s.purpose.trim(),status:v}),k({projectId:"",startDate:"",endDate:"",purpose:""}),x({}),b()},a=(t,n)=>{k(u=>({...u,[t]:n})),d[t]&&x(u=>{const i={...u};return delete i[t],i})};if(!j||!c)return null;const m=c.bookings.some(t=>{if(t.status==="cancelled"||t.status==="completed"||!s.startDate||!s.endDate)return!1;const n=new Date(t.startDate),u=new Date(t.endDate),i=new Date(s.startDate),v=new Date(s.endDate);return i<u&&v>n});return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-slate-100",children:"预约环境资源"}),e.jsxs("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:[c.name," - ",c.type]})]}),e.jsx("button",{onClick:b,className:"p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors",children:e.jsx(S,{className:"w-5 h-5 text-slate-500"})})]}),e.jsxs("form",{onSubmit:o,className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["选择项目 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:s.projectId,onChange:t=>a("projectId",t.target.value),className:`w-full px-4 py-2 rounded-lg border ${d.projectId?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent`,children:[e.jsx("option",{value:"",children:"请选择项目"}),p.filter(t=>t.status==="active").map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),d.projectId&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.projectId})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["开始日期 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:s.startDate,onChange:t=>a("startDate",t.target.value),min:new Date().toISOString().split("T")[0],className:`w-full px-4 py-2 rounded-lg border ${d.startDate?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent`}),d.startDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.startDate})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["结束日期 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:s.endDate,onChange:t=>a("endDate",t.target.value),min:s.startDate||new Date().toISOString().split("T")[0],className:`w-full px-4 py-2 rounded-lg border ${d.endDate?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent`}),d.endDate&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.endDate})]})]}),m&&e.jsxs("div",{className:"flex items-start gap-2 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:[e.jsx(E,{className:"w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-800 dark:text-red-200",children:"时间冲突"}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-300 mt-1",children:"所选时间段与现有预约存在冲突，请选择其他时间段"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:["预约目的 ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:s.purpose,onChange:t=>a("purpose",t.target.value),placeholder:"例如：功能测试、性能测试、集成测试等",rows:3,className:`w-full px-4 py-2 rounded-lg border ${d.purpose?"border-red-300 dark:border-red-700":"border-slate-300 dark:border-slate-600"} bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none`}),d.purpose&&e.jsx("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:d.purpose})]}),c.bookings.filter(t=>t.status!=="cancelled"&&t.status!=="completed").length>0&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4",children:[e.jsxs("h4",{className:"text-sm font-medium text-blue-900 dark:text-blue-100 mb-2 flex items-center gap-2",children:[e.jsx(N,{className:"w-4 h-4"}),"现有预约"]}),e.jsx("div",{className:"space-y-2",children:c.bookings.filter(t=>t.status!=="cancelled"&&t.status!=="completed").map(t=>e.jsxs("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("span",{className:"font-medium",children:t.projectName}),e.jsxs("span",{className:"text-blue-600 dark:text-blue-300 ml-2",children:[new Date(t.startDate).toLocaleDateString()," -"," ",new Date(t.endDate).toLocaleDateString()]})]},t.id))})]})]}),e.jsxs("div",{className:"flex items-center justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50",children:[e.jsx(g,{type:"button",variant:"secondary",onClick:b,children:"取消"}),e.jsx(g,{type:"button",onClick:()=>o({}),disabled:m,children:m?"存在冲突":"确认预约"})]})]})})},J=()=>{const{environmentResources:j,addEnvironmentResource:b,bookEnvironment:c}=M(),[r,p]=h.useState(!1),[l,s]=h.useState(!1),[k,d]=h.useState(null),[x,f]=h.useState("all"),o=h.useMemo(()=>x==="all"?j:j.filter(t=>t.type===x),[j,x]),a=t=>{switch(t){case"available":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300";case"occupied":return"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300";case"maintenance":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300";case"offline":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300";default:return"bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-300"}},m=t=>{switch(t){case"test":case"staging":case"production":case"integration":return e.jsx(C,{className:"w-5 h-5"});default:return e.jsx(N,{className:"w-5 h-5"})}};return e.jsxs(A,{children:[e.jsx(O,{title:"环境资源管理",description:"管理测试环境、发布窗口等非人力资源，避免基础设施冲突",actions:e.jsxs(g,{onClick:()=>p(!0),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"添加环境资源"]})}),e.jsx("div",{className:"flex gap-2 mb-6 overflow-x-auto",children:["all","test","staging","production","integration","device","license"].map(t=>e.jsx("button",{onClick:()=>f(t),className:`px-4 py-2 rounded-lg whitespace-nowrap transition-colors ${x===t?"bg-blue-600 text-white":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"}`,children:t==="all"?"全部":t.charAt(0).toUpperCase()+t.slice(1)},t))}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:o.map(t=>{const n=t.bookings.filter(i=>i.status==="active"||i.status==="reserved"),u=t.bookings.filter(i=>i.status!=="reserved"?!1:new Date(i.startDate)>new Date);return e.jsx(y,{className:"hover:shadow-lg transition-shadow",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:m(t.type)}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-slate-900 dark:text-slate-100",children:t.name}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:t.type})]})]}),e.jsxs(P,{className:a(t.status),children:[t.status==="available"&&e.jsx($,{className:"w-3 h-3 mr-1"}),t.status==="occupied"&&e.jsx(z,{className:"w-3 h-3 mr-1"}),t.status==="maintenance"&&e.jsx(E,{className:"w-3 h-3 mr-1"}),t.status]})]}),t.description&&e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 mb-4",children:t.description}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"当前使用"}),e.jsxs("span",{className:"font-medium text-slate-900 dark:text-slate-100",children:[n.length," 个预定"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"即将到来"}),e.jsxs("span",{className:"font-medium text-slate-900 dark:text-slate-100",children:[u.length," 个预定"]})]})]}),n.length>0&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mb-4",children:[e.jsx("p",{className:"text-xs text-blue-800 dark:text-blue-200 mb-1",children:"当前占用"}),e.jsx("p",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:n[0].projectName}),e.jsxs("p",{className:"text-xs text-blue-700 dark:text-blue-300 mt-1",children:[new Date(n[0].startDate).toLocaleDateString()," -"," ",new Date(n[0].endDate).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{onClick:()=>{d(t),s(!0)},variant:"secondary",className:"flex-1",disabled:t.status!=="available",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"预约"]}),e.jsx(g,{onClick:()=>d(t),variant:"secondary",children:"查看详情"})]})]})},t.id)})}),o.length===0&&e.jsxs(y,{className:"p-12 text-center",children:[e.jsx(C,{className:"w-16 h-16 text-slate-300 dark:text-slate-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2",children:"暂无环境资源"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mb-4",children:"添加测试环境、发布窗口等资源以避免冲突"}),e.jsxs(g,{onClick:()=>p(!0),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"添加第一个环境资源"]})]}),e.jsx(L,{isOpen:r,onClose:()=>p(!1),onAdd:t=>{b(t)}}),e.jsx(T,{isOpen:l,onClose:()=>s(!1),environment:k,onBook:t=>{c(t)}})]})};export{J as default};
