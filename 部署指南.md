# CTPM Tool 部署指南

## 1. 项目概述

CTPM (Comprehensive Task & Project Management) Tool 是一个完整的项目组合管理系统，提供了项目优先级评分、资源管理、成本分析、技能匹配等高级功能。

## 2. 技术栈

- **前端框架**: React 18 + TypeScript
- **构建工具**: Vite
- **状态管理**: Zustand
- **路由**: React Router v6
- **UI组件**: 
  - Lucide React (图标)
  - Recharts (图表)
  - @dnd-kit (拖拽)
- **样式**: Tailwind CSS
- **国际化**: i18next
- **日期处理**: date-fns

## 3. 本地开发

### 3.1 环境要求
- Node.js >= 16.0.0
- npm >= 8.0.0

### 3.2 安装依赖
```bash
cd d:\antigravity\CTPMtool
npm install
```

### 3.3 启动开发服务器
```bash
npm run dev
```

访问: http://localhost:5173

### 3.4 构建生产版本
```bash
npm run build
```

构建产物将输出到 `dist/` 目录。

### 3.5 预览生产构建
```bash
npm run preview
```

## 4. 生产环境部署

### 4.1 静态文件部署

由于本项目是纯前端应用，可以部署到任何静态文件托管服务：

#### 4.1.1 Nginx 部署

1. 构建项目：
```bash
npm run build
```

2. 配置 Nginx：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/CTPMtool/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

3. 重启 Nginx：
```bash
sudo nginx -t
sudo systemctl reload nginx
```

#### 4.1.2 Apache 部署

1. 构建项目
2. 将 `dist/` 目录内容复制到 Apache 根目录
3. 创建 `.htaccess` 文件：
```apache
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  RewriteRule ^index\.html$ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule . /index.html [L]
</IfModule>
```

#### 4.1.3 云服务部署

**Vercel**:
```bash
npm install -g vercel
vercel --prod
```

**Netlify**:
```bash
npm install -g netlify-cli
netlify deploy --prod --dir=dist
```

**GitHub Pages**:
1. 修改 `vite.config.ts`，添加 base 路径：
```typescript
export default defineConfig({
  base: '/your-repo-name/',
  // ...
})
```

2. 构建并部署：
```bash
npm run build
git add dist -f
git commit -m "Deploy"
git subtree push --prefix dist origin gh-pages
```

### 4.2 Docker 部署

#### 4.2.1 创建 Dockerfile

在项目根目录创建 `Dockerfile`：

```dockerfile
# Build stage
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# Production stage
FROM nginx:alpine

COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 4.2.2 创建 nginx.conf

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
```

#### 4.2.3 构建和运行

```bash
# 构建镜像
docker build -t ctpm-tool .

# 运行容器
docker run -d -p 8080:80 --name ctpm ctpm-tool

# 访问
# http://localhost:8080
```

### 4.3 Docker Compose 部署

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  ctpm-tool:
    build: .
    ports:
      - "8080:80"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
```

运行：
```bash
docker-compose up -d
```

## 5. 环境变量配置

本项目目前不需要环境变量配置。如果将来需要，可以创建 `.env` 文件：

```env
VITE_API_URL=https://api.example.com
VITE_APP_TITLE=CTPM Tool
```

在代码中使用：
```typescript
const apiUrl = import.meta.env.VITE_API_URL;
```

## 6. 性能优化建议

### 6.1 代码分割
已通过 React.lazy 和动态导入实现。

### 6.2 资源压缩
- 生产构建自动启用 minify
- 建议在服务器端启用 gzip/brotli 压缩

### 6.3 CDN 加速
将静态资源部署到 CDN：
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'chart-vendor': ['recharts'],
        }
      }
    }
  }
})
```

### 6.4 缓存策略
- HTML: no-cache
- JS/CSS: 1年缓存 + hash
- 图片/字体: 1年缓存

## 7. 监控和日志

### 7.1 错误监控
建议集成 Sentry：

```bash
npm install @sentry/react
```

```typescript
// src/main.tsx
import * as Sentry from "@sentry/react";

Sentry.init({
  dsn: "YOUR_SENTRY_DSN",
  environment: import.meta.env.MODE,
});
```

### 7.2 性能监控
使用 Web Vitals：

```bash
npm install web-vitals
```

```typescript
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

getCLS(console.log);
getFID(console.log);
getFCP(console.log);
getLCP(console.log);
getTTFB(console.log);
```

## 8. 安全建议

### 8.1 HTTPS
生产环境必须使用 HTTPS。

### 8.2 CSP 头
添加 Content Security Policy：

```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;";
```

### 8.3 其他安全头
```nginx
add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
add_header Referrer-Policy "strict-origin-when-cross-origin";
```

## 9. 备份和恢复

### 9.1 数据备份
本项目使用 localStorage 存储数据，建议：
- 定期导出数据（使用系统内置的备份功能）
- 实现自动备份到云端

### 9.2 数据恢复
通过系统设置页面的"恢复数据"功能。

## 10. 故障排查

### 10.1 白屏问题
- 检查浏览器控制台错误
- 确认路由配置正确
- 检查 base path 配置

### 10.2 路由404
- 确保服务器配置了 SPA fallback
- 检查 HashRouter vs BrowserRouter

### 10.3 性能问题
- 使用 React DevTools Profiler
- 检查是否有不必要的重渲染
- 优化大列表渲染

## 11. 更新和维护

### 11.1 依赖更新
```bash
# 检查过时的包
npm outdated

# 更新依赖
npm update

# 更新主版本
npx npm-check-updates -u
npm install
```

### 11.2 版本管理
使用语义化版本：
- MAJOR: 不兼容的 API 修改
- MINOR: 向下兼容的功能性新增
- PATCH: 向下兼容的问题修正

## 12. 联系和支持

- 项目仓库: [GitHub链接]
- 问题反馈: [Issues链接]
- 文档: 查看项目根目录的 Markdown 文档

---

**部署检查清单**:
- [ ] 运行 `npm run build` 成功
- [ ] 测试生产构建 `npm run preview`
- [ ] 配置服务器 SPA fallback
- [ ] 启用 HTTPS
- [ ] 配置安全头
- [ ] 启用 gzip 压缩
- [ ] 配置缓存策略
- [ ] 设置错误监控
- [ ] 备份数据
- [ ] 性能测试
